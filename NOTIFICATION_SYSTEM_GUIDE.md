# ุฏููู ูุธุงู ุงููุดุฑ ูุงูุชูุจููุงุช ุงููุฌุฏูู
# Smart Notification & Publishing System Guide

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ูุฅุฏุงุฑุฉ ุงููุดุฑ ูุงูุชูุจููุงุช ุงููุฌุฏููุฉ ููููุตุฉุ ูุชูุญ ููุฅุฏุงุฑุฉ:
- ุฌุฏููุฉ ุงูุฅุดุนุงุฑุงุช ูุณุจูุงู
- ุฅุฑุณุงู ุฃููุงุน ูุฎุชููุฉ ูู ุงููุญุชูู
- ุงุณุชูุฏุงู ูุฆุงุช ูุญุฏุฏุฉ ูู ุงููุณุชุฎุฏููู
- ุงูุชูุงูู ูุน Webhook ูุฅุฑุณุงู ุงูุจูุงูุงุช
- ูุชุงุจุนุฉ ุญุงูุฉ ุงูุฅุฑุณุงู ูุงูุฅุญุตุงุฆูุงุช

---

## ๐๏ธ ูููู ุงููุธุงู

### ุงูููุฏููุงุช (Models)

1. **NotificationTemplate** - ููุงูุจ ุงูุฅุดุนุงุฑุงุช
   - ููุงูุจ ุฌุงูุฒุฉ ูุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู
   - ุฃููุงุน ุงููุญุชูู ุงููุฎุชููุฉ
   
2. **ScheduledNotification** - ุงูุฅุดุนุงุฑุงุช ุงููุฌุฏููุฉ (ุงูุฃุณุงุณูุฉ)
   - ูุนูููุงุช ุงูุฅุดุนุงุฑ ูุงููุญุชูู
   - ุงูุฌุฏููุฉ (ุชุงุฑูุฎุ ููุชุ ููุทูุฉ ุฒูููุฉ)
   - ุงูุชูุฑุงุฑ (ููููุ ุฃุณุจูุนูุ ุดูุฑูุ ูุฎุตุต)
   - ุงููุณุชูุฏููู (ุทูุงุจุ ูุดุงูุฎุ ุญููุงุชุ ููุฑุฑุงุช)
   - ุงูุญุงูุฉ (ูุณูุฏุฉุ ูุฌุฏููุ ุฌุงุฑู ุงูุฅุฑุณุงูุ ุชู ุงูุฅุฑุณุงูุ ูุดูุ ููุบู)

3. **NotificationDispatchLog** - ุณุฌู ุงูุฅุฑุณุงู
   - ุชุชุจุน ูู ุนูููุฉ ุฅุฑุณุงู
   - ุนุฏุฏ ุงููุญุงููุงุช ูุงูุฃุฎุทุงุก
   - ุฑุฏูุฏ Webhook

4. **NotificationAuditLog** - ุณุฌู ุงูุชุฏููู
   - ูู ุฃูุดุฃ/ุนุฏู/ุฃุฑุณู ุงูุฅุดุนุงุฑ
   - ุงูุชุบููุฑุงุช ุงููุฎุชููุฉ

5. **WebhookEndpoint** - ููุงุท ููุงูุฉ Webhook
   - ุฅุนุฏุงุฏุงุช ููุงุท ุงูููุงูุฉ
   - ุฅุญุตุงุฆูุงุช ุงููุฌุงุญ ูุงููุดู

---

## ๐ง ุงูุฎุฏูุงุช (Services)

### PayloadBuilder
ูุจูู ุญูููุฉ JSON ููุฅุฑุณุงู ุฅูู Webhook ุจุงููููู ุงูุชุงูู:
```json
{
  "type": "lesson | reminder | motivation | awareness",
  "title": "ุนููุงู ุงูุฅุดุนุงุฑ",
  "message": "ูุต ุงูุฑุณุงูุฉ",
  "lesson": {
    "id": "",
    "title": "",
    "content": "",
    "surah": "",
    "ayah_from": "",
    "ayah_to": "",
    "lesson_url": ""
  },
  "target": {
    "role": "student | parent | teacher",
    "halaqa_id": "",
    "course_id": ""
  },
  "metadata": {
    "notification_id": "",
    "scheduled_at": "",
    "sent_at": "",
    "timezone": ""
  },
  "recipient": {
    "id": "",
    "name": "",
    "email": "",
    "role": ""
  }
}
```

### NotificationDispatchService
- ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุฅูู ุงููุณุชูููู
- ุขููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (Retry) ูุน ุชุฃุฎูุฑ ูุชุฒุงูุฏ
- ุฏุนู ุนุฏุฉ ููุงุท Webhook
- ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุชููุงุฆูุงู

### SchedulingService
- ุฅูุดุงุก ูุณุฎ ูุชูุฑุฑุฉ ูู ุงูุฅุดุนุงุฑุงุช
- ุญุณุงุจ ููุงุนูุฏ ุงูุชูุฑุงุฑ (ููููุ ุฃุณุจูุนูุ ุดูุฑู)
- ุฅุฏุงุฑุฉ ุญุงูุงุช ุงูุฅุดุนุงุฑุงุช

---

## ๐ฏ ุฃููุงุน ุงููุญุชูู ุงููุฏุนููุฉ

| ุงูููุน | ุงููุตู |
|-------|-------|
| `lesson` | ุฏุฑุณ ุงูููู |
| `reminder` | ุชุฐููุฑ ุจุงูุฏุฑุณ |
| `morning_motivation` | ุชุญููุฒ ุตุจุงุญู |
| `evening_reflection` | ุชุฃูู ูุณุงุฆู |
| `encouragement` | ุฑุณุงุฆู ุชุดุฌูุนูุฉ |
| `awareness` | ุฑุณุงุฆู ุชูุนููุฉ |
| `announcement` | ุฅุนูุงู ุนุงู |

---

## ๐ ุฃููุงุน ุงูุชูุฑุงุฑ

| ุงูููุน | ุงููุตู |
|-------|-------|
| `one_time` | ูุฑุฉ ูุงุญุฏุฉ |
| `daily` | ูููู |
| `weekly` | ุฃุณุจูุนู |
| `biweekly` | ูุฑุชูู ูู ุงูุฃุณุจูุน |
| `monthly` | ุดูุฑู |
| `custom` | ูุฎุตุต (ุฃูุงู ูุญุฏุฏุฉ) |

---

## ๐ฅ ุฃููุงุน ุงููุณุชูุฏููู

| ุงูููุน | ุงููุตู |
|-------|-------|
| `all_students` | ุฌููุน ุงูุทูุงุจ |
| `all_parents` | ุฌููุน ุฃูููุงุก ุงูุฃููุฑ |
| `all_teachers` | ุฌููุน ุงููุดุงูุฎ |
| `halaqa` | ุญููุฉ ูุญุฏุฏุฉ |
| `course` | ููุฑุฑ ูุญุฏุฏ |
| `specific_users` | ูุณุชุฎุฏููู ูุญุฏุฏูู |

---

## ๐ Webhook Integration

### ููุงุท ุงูููุงูุฉ ุงูุงูุชุฑุงุถูุฉ
- **Production**: `https://aivo.fun/webhook/qurancourses`
- **Test**: `https://aivo.fun/webhook-test/qurancourses`

### ุงูููุฏุฑุฒ ุงููุฑุณูุฉ
```
Content-Type: application/json
Accept: application/json
X-Source: quran-courses-platform
```

---

## ๐ ููุญุฉ ุงูุชุญูู

### URLs ุงูุฑุฆูุณูุฉ

| ุงููุณุงุฑ | ุงููุตู |
|--------|-------|
| `/notifications-system/` | ุงูุชูููู ุงูุฑุฆูุณู |
| `/notifications-system/calendar/` | ุนุฑุถ ุงูุชูููู |
| `/notifications-system/list/` | ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช |
| `/notifications-system/create/` | ุฅูุดุงุก ุฅุดุนุงุฑ ุฌุฏูุฏ |
| `/notifications-system/<id>/` | ุชูุงุตูู ุงูุฅุดุนุงุฑ |
| `/notifications-system/templates/` | ูุงุฆูุฉ ุงูููุงูุจ |

### ุงูููุฒุงุช ุงููุชุงุญุฉ

1. **ุงูุชูููู**
   - ุนุฑุถ ุดูุฑู/ุฃุณุจูุนู/ูููู
   - ุฃููุงู ูุฎุชููุฉ ุญุณุจ ุงูุญุงูุฉ
   - ุงูููุฑ ููุชูุงุตูู

2. **ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช**
   - ุชุตููุฉ ุญุณุจ ุงูุญุงูุฉ ูุงูููุน ูุงูุชุงุฑูุฎ
   - ุจุญุซ ูู ุงูุนูุงููู
   - ุฅุฌุฑุงุกุงุช ุณุฑูุนุฉ (ุฅุฑุณุงูุ ุชุนุฏููุ ุชุนุทููุ ุฅูุบุงุก)

3. **ุฅูุดุงุก/ุชุนุฏูู ุฅุดุนุงุฑ**
   - ุงุฎุชูุงุฑ ูุงูุจ ุฌุงูุฒ
   - ุชุญุฏูุฏ ุงููุณุชูุฏููู
   - ุฌุฏููุฉ ุงูุชุงุฑูุฎ ูุงูููุช
   - ุฅุนุฏุงุฏ ุงูุชูุฑุงุฑ

---

## โ๏ธ ุงูุฃูุงูุฑ ุงูุฅุฏุงุฑูุฉ

### ูุนุงูุฌุฉ ุงูุฅุดุนุงุฑุงุช ุงููุนููุฉ
```bash
python manage.py process_scheduled_notifications [--batch-size 50]
```

### ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฅุฑุณุงูุงุช ุงููุงุดูุฉ
```bash
python manage.py retry_failed_notifications [--notification-id UUID]
```

### ุชููุฆุฉ ููุงุท Webhook
```bash
python manage.py init_webhook_endpoints
```

---

## ๐ ุงูููุงู ุงููุฌุฏููุฉ (Celery)

### ุฅุฐุง ูุงู Celery ูุซุจุช:
ูุชู ุชุดุบูู ุงูููุงู ุงูุชุงููุฉ ุชููุงุฆูุงู:
- **ูู ุฏูููุฉ**: ูุนุงูุฌุฉ ุงูุฅุดุนุงุฑุงุช ุงููุณุชุญูุฉ
- **ูู 5 ุฏูุงุฆู**: ุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุฅุฑุณุงูุงุช ุงููุงุดูุฉ
- **ููููุงู**: ุชูุธูู ุงูุณุฌูุงุช ุงููุฏููุฉ (ุฃูุฏู ูู 90 ููู)

### ุจุฏูู Celery:
ูููู ุชุดุบูู ุงูููุงู ูุฏููุงู ุนุจุฑ ุงูุฃูุงูุฑ ุงูุฅุฏุงุฑูุฉ ุฃู ูู ุฎูุงู Views.

---

## ๐ ุงูุตูุงุญูุงุช

ุงููุธุงู ูุชุทูุจ ุตูุงุญูุงุช Admin/Staff ูููุตูู:
- `@user_passes_test(lambda u: u.is_staff or u.user_type == 'admin')`

---

## ๐ ุงููููุงุช ุงููููุดุฃุฉ

```
notifications_system/
โโโ __init__.py
โโโ admin.py              # ููุญุฉ ุงูุฅุฏุงุฑุฉ
โโโ apps.py               # ุชูููู ุงูุชุทุจูู
โโโ forms.py              # ููุงุฐุฌ HTML
โโโ models.py             # ููุงุฐุฌ ูุงุนุฏุฉ ุงูุจูุงูุงุช
โโโ services.py           # ุทุจูุฉ ุงูุฎุฏูุงุช
โโโ signals.py            # ุฅุดุงุฑุงุช Django
โโโ tasks.py              # ููุงู ุงูุฎูููุฉ
โโโ urls.py               # ูุณุงุฑุงุช URL
โโโ views.py              # ูุงุฌูุงุช ุงูุนุฑุถ
โโโ management/
โ   โโโ commands/
โ       โโโ init_webhook_endpoints.py
โ       โโโ process_scheduled_notifications.py
โ       โโโ retry_failed_notifications.py
โโโ templates/
    โโโ notifications_system/
        โโโ calendar.html
        โโโ list.html
        โโโ form.html
        โโโ detail.html
        โโโ confirm_delete.html
        โโโ template_list.html
        โโโ template_form.html
```

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### 1. ุฅูุดุงุก ุฅุดุนุงุฑ ุฌุฏูุฏ
1. ุงุฐูุจ ุฅูู `/notifications-system/`
2. ุงุถุบุท "ุฅุดุนุงุฑ ุฌุฏูุฏ"
3. ุงููุฃ ุงููุนูููุงุช:
   - ุงูุนููุงู ูุงูุฑุณุงูุฉ
   - ููุน ุงููุญุชูู
   - ุงููุณุชูุฏููู
   - ุงูุชุงุฑูุฎ ูุงูููุช
   - ููุน ุงูุชูุฑุงุฑ (ุงุฎุชูุงุฑู)
4. ุงุถุบุท "ุญูุธ"

### 2. ุฅุฑุณุงู ููุฑู
1. ูู ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุชุ ุงุถุบุท ุฃููููุฉ ุงูุฅุฑุณุงู ๐จ
2. ุฃู ูู ุตูุญุฉ ุงูุชูุงุตููุ ุงุถุบุท "ุฅุฑุณุงู ููุฑู"

### 3. ูุฑุงูุจุฉ ุงูุญุงูุฉ
1. ุงุฐูุจ ุฅูู ุตูุญุฉ ุชูุงุตูู ุงูุฅุดุนุงุฑ
2. ุดุงูุฏ:
   - ุฅุญุตุงุฆูุงุช ุงูุฅุฑุณุงู
   - ุณุฌู ุงููุญุงููุงุช
   - ุณุฌู ุงูุชุฏููู

---

## ๐ ุงููุชุบูุฑุงุช ูู ุงูุฑุณุงุฆู

ูููู ุงุณุชุฎุฏุงู ุงููุชุบูุฑุงุช ุงูุชุงููุฉ ูู ููุงูุจ ุงูุฑุณุงุฆู:
- `{student_name}` - ุงูุงุณู ุงููุงูู
- `{first_name}` - ุงูุงุณู ุงูุฃูู
- `{username}` - ุงุณู ุงููุณุชุฎุฏู

---

## ๐จ ุงูุชูุงูู ูุน ุงููุงุฌูุฉ

ุชู ุฅุถุงูุฉ ูุณู "ุงููุดุฑ ูุงูุชูุจููุงุช" ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ูููุญุฉ ุงูุชุญูู.

---

## ๐ง ุงูุชุฎุตูุต

### ุฅุถุงูุฉ Webhook ุฌุฏูุฏ
```python
from notifications_system.models import WebhookEndpoint

WebhookEndpoint.objects.create(
    name='My Webhook',
    url='https://example.com/webhook',
    endpoint_type=WebhookEndpoint.EndpointType.PRIMARY,
    is_active=True
)
```

### ุฅูุดุงุก ูุงูุจ ุฌุฏูุฏ
```python
from notifications_system.models import NotificationTemplate

NotificationTemplate.objects.create(
    name='ุชุญููุฒ ุตุจุงุญู',
    content_type='morning_motivation',
    title_template='ุตุจุงุญ ุงูุฎูุฑ {first_name}!',
    message_template='...',
    is_active=True
)
```

---

## ๐ ุงูุฏุนู

ูููุฒูุฏ ูู ุงููุนูููุงุชุ ุฑุงุฌุน:
- ููู `notifications_system/models.py` ููููุฏููุงุช
- ููู `notifications_system/services.py` ููุฎุฏูุงุช
- ููู `notifications_system/views.py` ูููุงุฌูุงุช
