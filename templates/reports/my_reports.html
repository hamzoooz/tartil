{% extends 'base.html' %}

{% block title %}تقاريري - ترتيل{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-chart-bar text-primary me-2"></i>تقاريري</h2>
            <p class="text-muted">تقارير أدائي وتقدمي في الحفظ</p>
        </div>
    </div>

    <!-- Monthly Stats -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-primary">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{ monthly_stats.total_recitations }}</div>
                        <small>التسميعات هذا الشهر</small>
                    </div>
                    <i class="fas fa-microphone"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-success">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{ monthly_stats.average_grade }}%</div>
                        <small>متوسط الدرجة</small>
                    </div>
                    <i class="fas fa-star"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-info">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{ monthly_stats.new_memorization }}</div>
                        <small>حفظ جديد</small>
                    </div>
                    <i class="fas fa-plus-circle"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-warning">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stat-value">{{ monthly_stats.review }}</div>
                        <small>مراجعة</small>
                    </div>
                    <i class="fas fa-redo"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Latest Report -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-file-alt me-2"></i>آخر تقرير</span>
                    <a href="{% url 'reports:report_list' %}" class="btn btn-sm btn-outline-light">عرض الكل</a>
                </div>
                <div class="card-body">
                    {% if latest_report %}
                    <div class="row">
                        <div class="col-md-6">
                            <h5>{{ latest_report.get_report_period_display }}</h5>
                            <p class="text-muted">{{ latest_report.start_date|date:"Y-m-d" }} إلى {{ latest_report.end_date|date:"Y-m-d" }}</p>
                            <table class="table table-sm">
                                <tr>
                                    <td>التسميعات:</td>
                                    <td class="fw-bold">{{ latest_report.total_recitations }}</td>
                                </tr>
                                <tr>
                                    <td>متوسط الدرجة:</td>
                                    <td class="fw-bold">{{ latest_report.average_grade }}%</td>
                                </tr>
                                <tr>
                                    <td>نسبة الحضور:</td>
                                    <td class="fw-bold">{{ latest_report.attendance_rate }}%</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6 text-center">
                            <div class="display-1 
                                {% if latest_report.average_grade >= 90 %}text-success
                                {% elif latest_report.average_grade >= 70 %}text-primary
                                {% elif latest_report.average_grade >= 60 %}text-warning
                                {% else %}text-danger{% endif %}">
                                {{ latest_report.average_grade }}
                            </div>
                            <p class="text-muted">المتوسط العام</p>
                            <a href="{% url 'reports:report_view' latest_report.pk %}" class="btn btn-primary">
                                <i class="fas fa-eye me-2"></i>عرض التفاصيل
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                        <p class="text-muted">لا توجد تقارير متاحة حالياً</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Latest Certificate -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-certificate me-2"></i>آخر شهادة
                </div>
                <div class="card-body text-center">
                    {% if latest_certificate %}
                    {% if latest_certificate.generated_file %}
                    <img src="{{ latest_certificate.generated_file.url }}" class="img-fluid rounded mb-3" alt="شهادة">
                    {% endif %}
                    <h5>{{ latest_certificate.degree_title }}</h5>
                    <p class="text-muted">{{ latest_certificate.issue_date|date:"Y-m-d" }}</p>
                    <a href="{% url 'reports:certificate_download' latest_certificate.pk %}" class="btn btn-success">
                        <i class="fas fa-download me-2"></i>تحميل
                    </a>
                    {% else %}
                    <div class="py-4">
                        <i class="fas fa-certificate fa-4x text-muted mb-3"></i>
                        <p class="text-muted">لم تحصل على أي شهادات بعد</p>
                        <p class="small text-muted">استمر في التقدم للحصول على شهاداتك!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Chart -->
    <div class="card">
        <div class="card-header">
            <i class="fas fa-chart-line me-2"></i>تقدمي في الحفظ
        </div>
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <canvas id="progressChart"></canvas>
                </div>
                <div class="col-md-4">
                    <h5>الإحصائيات العامة</h5>
                    <table class="table">
                        <tr>
                            <td>الصفحات المحفوظة:</td>
                            <td class="fw-bold">{{ user.student_profile.total_memorized_pages }}</td>
                        </tr>
                        <tr>
                            <td>نسبة الإنجاز:</td>
                            <td class="fw-bold">{{ user.student_profile.memorization_percentage }}%</td>
                        </tr>
                        <tr>
                            <td>الأجزاء المحفوظة:</td>
                            <td class="fw-bold">{{ user.student_profile.total_memorized_juz }}</td>
                        </tr>
                        <tr>
                            <td>إجمالي النقاط:</td>
                            <td class="fw-bold">{{ user.student_profile.total_points }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // رسم بياني للتقدم
    const ctx = document.getElementById('progressChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['محفوظ', 'متبقي'],
            datasets: [{
                data: [
                    {{ user.student_profile.total_memorized_pages }},
                    604 - {{ user.student_profile.total_memorized_pages }}
                ],
                backgroundColor: ['#1a5f4a', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>
{% endblock %}
